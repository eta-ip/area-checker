<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ファイルアップロード</title>
  <link rel="stylesheet" href="https://eta-ip.com/css/style.css">
</head>
<style>  /* 大容量アップロード用 */
.upload-box {max-width:600px; margin:20px auto 10px; padding:50px 20px; border:2px dashed #ccc; border-radius:10px; text-align:center; transition:border-color 0.3s ease-in-out;}
.upload-box.dragover {border-color:#d4a373;}
.button {margin-top:20px; padding:12px 28px; font-size:16px; font-weight:bold; border:none; border-radius:6px; background-color:#d4a373; color:#fff; cursor:pointer; transition:background-color 0.2s;}
.button:hover {background-color:#c6905f;}
input[type="file"] {display:none;}
.note {margin-top:15px; font-size:14px; color:#888;}
#message {max-width:600px; margin:10px auto 20px; padding:12px; font-size:16px; text-align:center; color:#0d3e19; border:1px solid #c3e6cb; border-radius:6px; display:none;}
.success {font-weight:bold;}
#fileList {max-width:600px; margin:20px auto; padding:20px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.1);}
.file-item {display:flex; flex-direction:column; align-items:flex-start; justify-content:space-between; padding:8px 0; border-bottom:1px solid #eee;}
.progress {width:100%; height:8px; margin-top:5px; background:#d4a373; border-radius:4px; overflow:hidden;}
.progress-inner {width:0%; height:100%; background:#efc397; transition:width 0.3s ease;}
.link-box {margin-top:15px; padding:8px; font-size:14px; color:#333; border-left:4px solid #ffe2c6; word-break:break-word;}
.remove-button {margin-left:10px; font-size:14px; color:red; background:none; border:none; cursor:pointer;}
.warn {margin-top:5px; color:red;}
.total-size {margin-top:15px; font-size:14px; font-weight:bold; color:#333;}
#clearAllBtn {margin-top:10px; background-color:#999;}
#clearAllBtn:hover {background-color:#777;}
</style>
<body>
<header>
  <p id="logo">
    <a href="https://eta-ip.com/index.html">
      <img src="https://eta-ip.com/img/logo.png" alt="一級建築士事務所 エイタ国際企画のロゴ">
    </a>
  </p>
  <div id="menubar_hdr" role="button" aria-label="メニュー切替" tabindex="0">
    <span></span><span></span><span></span>
  </div>
  <div id="menubar" class="d-n">
    <nav>
      <ul>
        <li><a href="https://eta-ip.com/projects.html" class="btn00"><span class="btn00__text">Projects</span><span class="btn00__text">施工実績</span></a></li>
        <li><a href="https://eta-ip.com/corporate.html" class="btn00"><span class="btn00__text">Profile</span><span class="btn00__text">企業情報</span></a></li>
        <li><a href="https://eta-ip.com/flow.html" class="btn00"><span class="btn00__text">Workflow</span><span class="btn00__text">設計の流れ</span></a></li>
        <li><a href="https://eta-ip.com/contact.php" class="btn00"><span class="btn00__text">Contact Us</span><span class="btn00__text">お問い合わせ</span></a></li>
      </ul>
    </nav>
  </div>
</header>

<div id="container">
  <main id="contents">
    <section aria-labelledby="section-title-flow">
      <h1 id="section-title-flow">ファイルアップロードページ</h1>
        <div id="uploadArea">
      <label for="comment" style="font-weight: bold;text-align: center; display: block; margin-bottom: 5px;margin-top: 100px;">ファイルアップロード（1ファイルあたり最大 256MB）</label>
      <div class="upload-box" id="dropArea">
        <p>ここにファイルをドラッグ＆ドロップ<br>または</p>
        <button class="button" onclick="document.getElementById('fileInput').click();">ファイルを選択</button>
        <input type="file" id="fileInput" multiple>
        <p class="note">※ 最大アップロード容量：合計:1GB／禁止形式：exe, php, bat, sh</p>
      </div>

      <div style="max-width: 600px; margin: 20px auto;">
        <label for="comment" style="font-weight: bold; text-align: center;display: block; margin-bottom: 5px;margin-top: 100px;">送信者コメント（任意）</label>
        <textarea id="comment" rows="4" placeholder="例：図面一式をお送りします。" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 15px;"></textarea>
      </div></div>

      <div id="message"></div>
      <div id="fileList"></div>

      <div id="termsContainer" style="max-width: 600px; margin: 10px auto; font-size: 17px;">
        <label style="display: flex; align-items: center; justify-content: center; gap: 6px;">
          <input type="checkbox" id="agreeTerms">
          <span><a href="terms.html" target="_blank" style="color: #b65d03; text-decoration: underline;">利用規約</a> に同意します。</span>
        </label>
        <p id="termsHint" style="color:#999; font-size: 14px; text-align:center; display:none;">
          ※利用規約に同意するとアップロードできます
        </p>
      </div>

      <div style="text-align: center;">
        <button class="button" id="startUploadBtn" disabled>アップロード開始</button>
        <button class="button" id="clearAllBtn" style="display:none;">すべて削除</button>
      </div>
    </section>
  </main>
</div>

  <script>
    const dropArea = document.getElementById("dropArea");
    const fileInput = document.getElementById("fileInput");
    const fileList = document.getElementById("fileList");
    const startUploadBtn = document.getElementById("startUploadBtn");
    const clearAllBtn = document.getElementById("clearAllBtn");
    const message = document.getElementById("message");
    const commentInput = document.getElementById("comment");

    const MAX_SIZE = 256 * 1024 * 1024;
    const forbiddenExtensions = ['exe', 'php', 'bat', 'sh'];
    let selectedFiles = [];

    dropArea.addEventListener("dragover", (e) => {
      e.preventDefault();
      dropArea.classList.add("dragover");
    });

    dropArea.addEventListener("dragleave", () => {
      dropArea.classList.remove("dragover");
    });

    dropArea.addEventListener("drop", (e) => {
      e.preventDefault();
      dropArea.classList.remove("dragover");
      handleFiles(e.dataTransfer.files);
    });

    fileInput.addEventListener("change", () => {
      handleFiles(fileInput.files);
    });

    clearAllBtn.addEventListener("click", () => {
      selectedFiles = [];
      fileList.innerHTML = '';
      updateTotalSize();
      startUploadBtn.disabled = true;
      clearAllBtn.style.display = 'none';
    });

    function handleFiles(files) {
      message.style.display = "none";
      message.textContent = "";
      fileList.querySelectorAll(".warn").forEach(el => el.remove());
      for (const file of files) {
        const parts = file.name.split('.');
        const ext = parts.length > 1 ? parts.pop().toLowerCase() : '';
        if (forbiddenExtensions.includes(ext)) {
          const warn = document.createElement("div");
          warn.textContent = `⚠️ 拒否されたファイル形式（.${ext}）: ${file.name}`;
          warn.className = "warn";
          fileList.appendChild(warn);
          continue;
        }
        if (file.size > MAX_SIZE) {
          const warn = document.createElement("div");
          warn.textContent = `⚠️ サイズ超過（256MB以上）: ${file.name}`;
          warn.className = "warn";
          fileList.appendChild(warn);
          continue;
        }
        const duplicate = selectedFiles.some(f => f && f.name === file.name && f.size === file.size);
        if (duplicate) continue;
        const index = selectedFiles.length;
        selectedFiles.push(file);
        const div = document.createElement("div");
        div.className = "file-item";
        div.id = `file-item-${index}`;
        div.innerHTML = `
          <div>${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB）<button class="remove-button" onclick="removeFile(${index})">🗑削除</button></div>
          <div class="progress"><div class="progress-inner" id="progress-${index}"></div></div>
          <div id="link-${index}"></div>
        `;
        fileList.appendChild(div);
      }
      updateTotalSize();
      toggleUploadButton();
      clearAllBtn.style.display = selectedFiles.some(f => f !== null) ? 'inline-block' : 'none';
    }

    function removeFile(index) {
      const item = document.getElementById(`file-item-${index}`);
      if (item) item.remove();
      selectedFiles[index] = null;
      updateTotalSize();
      toggleUploadButton();
      clearAllBtn.style.display = selectedFiles.some(f => f !== null) ? 'inline-block' : 'none';
    }

    function updateTotalSize() {
      const existing = document.getElementById("total-size");
      if (existing) existing.remove();
      const total = selectedFiles.reduce((sum, f) => f ? sum + f.size : sum, 0);
      if (total > 0) {
        const totalDiv = document.createElement("div");
        totalDiv.id = "total-size";
        totalDiv.className = "total-size";
        totalDiv.textContent = `📦 合計サイズ: ${(total / 1024 / 1024).toFixed(2)} MB`;
        fileList.appendChild(totalDiv);
      }
    }

    startUploadBtn.addEventListener("click", () => {
      message.style.display = "none";
      message.textContent = "";
      const validFiles = selectedFiles.map((file, index) => ({ file, index })).filter(item => item.file !== null);
      let completedCount = 0;
      let hasError = false;
      validFiles.forEach(({ file, index }) => {
        uploadFile(file, index, (errorOccurred) => {
          completedCount++;
          if (errorOccurred) hasError = true;
          if (completedCount === validFiles.length) {
            if (hasError) {
              message.innerHTML = `<span class="success" style="color:red;">❌ エラーが発生しました。</span>`;
            } else {
              message.innerHTML = `<span class="success">✅ 全ファイルのアップロードが完了しました。データ確認後、担当者よりご連絡差し上げます。</span>`;document.getElementById("uploadArea").style.display = "none";document.getElementById("section-title-flow").textContent = "アップロード完了";
            }
            document.querySelectorAll(".remove-button").forEach(btn => btn.style.display = "none");
            message.style.display = "block";
            commentInput.value = "";
            startUploadBtn.style.display = "none";
            clearAllBtn.style.display = "none";
            const doneButton = document.createElement("a");
            doneButton.href = "https://eta-ip.com";
            doneButton.textContent = "完了";
            doneButton.className = "button";
            doneButton.style.marginTop = "20px";
            doneButton.style.display = "inline-block";
            doneButton.style.textDecoration = "none";
            message.appendChild(document.createElement("br"));
            message.appendChild(doneButton);
          }
        });
      });
    });

    function uploadFile(file, index, callback) {
      const formData = new FormData();
      formData.append("file", file);
      formData.append("comment", commentInput.value);
      const xhr = new XMLHttpRequest();
      xhr.open("POST", "../backend/upload.php", true);
      xhr.upload.onprogress = function (e) {
        if (e.lengthComputable) {
          const percent = (e.loaded / e.total) * 100;
          const progressBar = document.getElementById("progress-" + index);
          if (progressBar) progressBar.style.width = percent + "%";
        }
      };
      xhr.onload = function () {
        const linkBox = document.getElementById("link-" + index);
        if (xhr.status === 200) {
          try {
            const res = JSON.parse(xhr.responseText);
            if (res && res.url) {
              linkBox.innerHTML = `<div class="link-box">🔗 <a href="${res.url}" target="_blank">${res.url}</a><br>🕒 このファイルは24時間後に自動削除されます</div>`;
              callback(false);
            } else {
              linkBox.innerHTML = `<span style="color: red;">❌ リンク生成に失敗しました</span>`;
              callback(true);
            }
          } catch {
            linkBox.innerHTML = `<span style="color: red;">❌ 応答形式エラー</span>`;
            callback(true);
          }
        } else {
          linkBox.innerHTML = `<span style="color: red;">❌ アップロード失敗（HTTP ${xhr.status}）</span>`;
          callback(true);
        }
      };
      xhr.onerror = function () {
        const linkBox = document.getElementById("link-" + index);
        linkBox.innerHTML = `<span style="color: red;">❌ 通信エラー</span>`;
        callback(true);
      };
      xhr.send(formData);
    }
  </script>
<script>
  const agreeTerms = document.getElementById("agreeTerms");
  const termsContainer = document.getElementById("termsContainer");
  const termsHint = document.getElementById("termsHint");

  function toggleUploadButton() {
    const hasFile = selectedFiles.some(f => f !== null);
    const enabled = agreeTerms.checked && hasFile;
    startUploadBtn.disabled = !enabled;
    termsHint.style.display = enabled ? 'none' : 'block';
  }

  agreeTerms.addEventListener("change", toggleUploadButton);

  startUploadBtn.addEventListener("click", () => {
    termsContainer.style.display = "none";
  });
</script>

<footer>
<small>&copy; 2024 <a href="https://eta-ip.com/index.html">ETA LLC.</a></small><br>
<address>〒198-0046 東京都青梅市日向和田2-928<br></address>
</footer>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vegas/2.5.4/vegas.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/protonet-jquery.inview/1.1.2/jquery.inview.min.js" defer></script>
  <script src="https://eta-ip.com/js/jquery.inview_set.js" defer></script>
  <script src="https://eta-ip.com/js/main.js" defer></script>
</body>
</html>
